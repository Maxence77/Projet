# Nom du workflow tel qu'il apparaît dans l'onglet "Actions" de GitHub
name: "DevSecOps - Phase 1: SonarCloud SAST"

# --------------------------
# DÉCLENCHEURS (Triggers)
# --------------------------
# Détermine quand ce workflow doit s'exécuter
on:
  push:
    # Déclenche l'analyse quand du code est poussé sur ces branches (CI)
    branches: [ main, DevCops ]
  pull_request:
    # Déclenche l'analyse quand une Pull Request est ouverte ou mise à jour (pour la vérification avant fusion)
    branches: [ main, DevCops ]

# PERMISSIONS
# Définit les autorisations nécessaires pour que le workflow puisse interagir avec le dépôt
permissions:
  contents: read
  # pull-requests: write est nécessaire pour que SonarCloud puisse ajouter des commentaires ou des vérifications au statut des Pull Requests
  pull-requests: write 

# --------------------------
# JOBS (Tâches)
# --------------------------
jobs:
  # Début du premier (et unique pour l'instant) travail : l'analyse SonarCloud
  sonar_scan:
    # Nom affiché pour cette tâche
    name: SonarCloud Scan (SAST)
    # Définit le type de machine virtuelle (runner) qui exécutera cette tâche
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        # Utilise l'action standard de GitHub pour récupérer le code du dépôt sur le runner
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 est essentiel pour SonarCloud. Il récupère l'historique complet du dépôt pour une analyse précise des changements
          fetch-depth: 0 

      - name: Setup Environment (PHP/JS)
        # Exécute des commandes shell pour installer les outils de base nécessaires aux projets PHP et JS
        run: |
          sudo apt-get update
          # Installation de Node.js, NPM (pour JS) et Composer (pour PHP)
          sudo apt-get install -y nodejs npm composer
          
      - name: Install dependencies (PHP/JS)
        # Exécute des commandes pour installer les dépendances spécifiques au projet (telles que définies dans package.json ou composer.json)
        # L'analyse SonarCloud est plus précise lorsque les dépendances sont installées.
        run: |
          # Installation des dépendances PHP. '|| echo "..."' permet au workflow de ne pas échouer si le fichier composer.json n'existe pas.
          composer install --no-dev --prefer-dist || echo "Skipping PHP dependencies."
          # Installation des dépendances JS.
          npm install || echo "Skipping JS dependencies."

      - name: SonarCloud Analysis
        # Utilise l'action officielle de SonarSource pour lancer le scanner
        uses: SonarSource/sonarcloud-github-action@v2.3.0
        env:
          # Fournit le jeton secret pour l'authentification auprès du service SonarCloud
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # Arguments passés au scanner SonarCloud
          args: >
            # Définit la clé unique du projet sur SonarCloud (nécessaire pour lier les résultats)
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            # Indique au scanner d'analyser tous les fichiers dans le répertoire racine et ses sous-dossiers (y compris php, js, html, etc.)
            -Dsonar.sources=. 
            # Liste des fichiers à ignorer dans l'analyse (fichiers minifiés, CSS, documents, etc.)
            -Dsonar.exclusions=**/*.min.js,**/*.css,**/*.html,**/*.yml,**/*.md